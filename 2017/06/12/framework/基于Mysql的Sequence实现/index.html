<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Mysql,Sequence," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="之前有提到过，团队更换新框架。新的业务全部使用新的框架，甚至是新的数据库–Mysql。这边之前一直是使用oracle，各种订单号、流水号、批次号啥的，都是直接使用oracle的sequence提供的数字序列号。现在数据库更换成Mysql了，显然以前的老方法不能适用了。  需要新写一个：  分布式场景使用 满足一定的并发要求找了一些相关的资料，发现mysql这方面的实现，原理都是一条数据库记录，">
<meta name="keywords" content="Mysql,Sequence">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Mysql的Sequence实现">
<meta property="og:url" content="http://zhanglong.wiki/2017/06/12/framework/基于Mysql的Sequence实现/index.html">
<meta property="og:site_name" content="阿拉丁的混乱笔记">
<meta property="og:description" content="之前有提到过，团队更换新框架。新的业务全部使用新的框架，甚至是新的数据库–Mysql。这边之前一直是使用oracle，各种订单号、流水号、批次号啥的，都是直接使用oracle的sequence提供的数字序列号。现在数据库更换成Mysql了，显然以前的老方法不能适用了。  需要新写一个：  分布式场景使用 满足一定的并发要求找了一些相关的资料，发现mysql这方面的实现，原理都是一条数据库记录，">
<meta property="og:updated_time" content="2017-06-12T15:02:06.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于Mysql的Sequence实现">
<meta name="twitter:description" content="之前有提到过，团队更换新框架。新的业务全部使用新的框架，甚至是新的数据库–Mysql。这边之前一直是使用oracle，各种订单号、流水号、批次号啥的，都是直接使用oracle的sequence提供的数字序列号。现在数据库更换成Mysql了，显然以前的老方法不能适用了。  需要新写一个：  分布式场景使用 满足一定的并发要求找了一些相关的资料，发现mysql这方面的实现，原理都是一条数据库记录，">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhanglong.wiki/2017/06/12/framework/基于Mysql的Sequence实现/"/>





  <title> 基于Mysql的Sequence实现 | 阿拉丁的混乱笔记 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?986e78470dad7463885a41106c411043";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">阿拉丁的混乱笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">编的好费力!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/06/12/framework/基于Mysql的Sequence实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                基于Mysql的Sequence实现
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T00:00:00+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/framework/" itemprop="url" rel="index">
                    <span itemprop="name">framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2017/06/12/framework/基于Mysql的Sequence实现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>  之前有提到过，团队更换新框架。新的业务全部使用新的框架，甚至是新的数据库–Mysql。<br>这边之前一直是使用oracle，各种订单号、流水号、批次号啥的，都是直接使用oracle的sequence提供的数字序列号。现在数据库更换成Mysql了，显然以前的老方法不能适用了。<br>  需要新写一个：</p>
<ul>
<li>分布式场景使用</li>
<li>满足一定的并发要求<br>找了一些相关的资料，发现mysql这方面的实现，原理都是一条数据库记录，不断update它的值。然后大部分的实现方案，都用到了函数。<br>贴一下网上的代码：<h3 id="基于mysql函数实现"><a href="#基于mysql函数实现" class="headerlink" title="基于mysql函数实现"></a>基于mysql函数实现</h3><h4 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `t_sequence` (</div><div class="line">`sequence_name`  varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &apos;序列名称&apos; ,</div><div class="line">`value`  int(11) NULL DEFAULT NULL COMMENT &apos;当前值&apos; ,</div><div class="line">PRIMARY KEY (`sequence_name`)</div><div class="line">)</div><div class="line">ENGINE=InnoDB</div><div class="line">DEFAULT CHARACTER SET=utf8 COLLATE=utf8_general_ci</div><div class="line">ROW_FORMAT=COMPACT</div><div class="line">;</div><div class="line">```  </div><div class="line"></div><div class="line">#### 获取下一个值</div></pre></td></tr></table></figure>
</li>
</ul>
<p>CREATE DEFINER = <code>root</code>@<code>localhost</code> FUNCTION <code>nextval</code>(sequence_name varchar(64))<br> RETURNS int(11)<br>BEGIN<br>    declare current integer;<br>    set current = 0;</p>
<pre><code>update t_sequence t set t.value = t.value + 1 where t.sequence_name = sequence_name;
select t.value into current from t_sequence t where t.sequence_name = sequence_name;

return current;
</code></pre><p>end;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 基于java缓存实现</div><div class="line">  并发场景有可能会出问题吧，虽然可以在业务层加锁，但分布式场景就无法保证了，然后效率应该也不会高。</div><div class="line">自己实现一个，java版</div><div class="line">  原理：</div><div class="line">   - 读取一条记录，缓存一个数据段，如：0-100，将记录的当前值从0修改为100</div><div class="line">   - 数据库乐观锁更新，允许重试</div><div class="line">   - 读取数据从缓存中读取，用完再读取数据库</div><div class="line"></div><div class="line">  不废话，上代码：</div><div class="line">#### 表结构</div></pre></td></tr></table></figure></p>
<p>CREATE TABLE <code>t_pub_sequence</code> (<br>  <code>SEQ_NAME</code> varchar(128) CHARACTER SET utf8 NOT NULL COMMENT ‘序列名称’,<br>  <code>SEQ_VALUE</code> bigint(20) NOT NULL COMMENT ‘目前序列值’,<br>  <code>MIN_VALUE</code> bigint(20) NOT NULL COMMENT ‘最小值’,<br>  <code>MAX_VALUE</code> bigint(20) NOT NULL COMMENT ‘最大值’,<br>  <code>STEP</code> bigint(20) NOT NULL COMMENT ‘每次取值的数量’,<br>  <code>TM_CREATE</code> datetime NOT NULL COMMENT ‘创建时间’,<br>  <code>TM_SMP</code> datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT ‘修改时间’,<br>  PRIMARY KEY (<code>SEQ_NAME</code>)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=’流水号生成表’;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### sequence接口</div></pre></td></tr></table></figure></p>
<p>/**</p>
<ul>
<li><p></p></li>
<li>@author coderzl</li>
<li>@Title MysqlSequence</li>
<li>@Description 基于mysql数据库实现的序列</li>
<li>@date 2017/6/6 23:03<br><em>/<br>public interface MysqlSequence {<br> /*</em><ul>
<li><p></p></li>
<li>获取指定sequence的序列号</li>
<li><p></p></li>
<li>@param  seqName sequence名</li>
<li>@return String 序列号<br>*/<br>public String nextVal(String seqName);<br>}<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 序列区间</div><div class="line">（用于本地缓存一段序列）</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>/**</p>
<ul>
<li><p></p><br>*</li>
<li>@author coderzl</li>
<li>@Title SequenceRange</li>
<li>@Description 序列区间，用于缓存序列</li>
<li><p>@date 2017/6/6 22:58<br><em>/<br>@Data<br>public class SequenceRange {<br> private final long       min;<br> private final long       max;<br> /**  </em>/<br> private final AtomicLong value;<br> /<em>* 是否超限 </em>/<br> private volatile boolean over = false;</p>
<p> /**</p>
<ul>
<li>构造.<br>*</li>
<li>@param min </li>
<li><p>@param max<br>*/<br>public SequenceRange(long min, long max) {<br> this.min = min;<br> this.max = max;<br> this.value = new AtomicLong(min);<br>}</p>
<p>/**</p>
</li>
<li><p>Gets and increment</p><br>*</li>
<li><p>@return<br>*/<br>public long getAndIncrement() {<br> long currentValue = value.getAndIncrement();<br> if (currentValue &gt; max) {</p>
<pre><code>over = true;
return -1;
</code></pre><p> }</p>
<p> return currentValue;<br>}</p>
</li>
</ul>
</li>
</ul>
<p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### BO </div><div class="line">  对应数据库记录</div></pre></td></tr></table></figure></p>
<p>@Data<br>public class MysqlSequenceBo {<br>    /**</p>
<pre><code> * seq名
 */
private String seqName;
/**
 * 当前值
 */
private Long seqValue;
/**
 * 最小值
 */
private Long minValue;
/**
 * 最大值
 */
private Long maxValue;
/**
 * 每次取值的数量
 */
private Long step;
/**  */
private Date tmCreate;
/**  */
private Date tmSmp;

public boolean validate(){
  //一些简单的校验。如当前值必须在最大最小值之间。step值不能大于max与min的差
  if (StringUtil.isBlank(seqName) || minValue &lt; 0 || maxValue &lt;= 0 || step &lt;= 0 || minValue &gt;= maxValue || maxValue - minValue &lt;= step ||seqValue &lt; minValue || seqValue &gt; maxValue ) {
        return false;
    }
    return true;  
}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### DAO </div><div class="line">增删改查，其实就用到了改和查</div></pre></td></tr></table></figure></p>
<p>public interface MysqlSequenceDAO {<br>    /**</p>
<pre><code>* 
*/
public int createSequence(MysqlSequenceBo bo);

public int updSequence(@Param(&quot;seqName&quot;) String seqName, @Param(&quot;oldValue&quot;) long oldValue ,@Param(&quot;newValue&quot;) long newValue);

public int delSequence(@Param(&quot;seqName&quot;) String seqName);

public MysqlSequenceBo getSequence(@Param(&quot;seqName&quot;) String seqName);

public List&lt;MysqlSequenceBo&gt; getAll();
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### Mapper</div></pre></td></tr></table></figure></p>
<p>&lt;?xml version=”1.0” encoding=”UTF-8” ?&gt;<br>&lt;!DOCTYPE mapper PUBLIC “-//mybatis.org//DTD Mapper 3.0//EN” “<a href="http://mybatis.org/dtd/mybatis-3-mapper.dtd" target="_blank" rel="external">http://mybatis.org/dtd/mybatis-3-mapper.dtd</a>“ &gt;</p>
<p><mapper namespace="com.xxxxx.core.sequence.impl.dao.MysqlSequenceDAO"><br>    <resultmap id="BaseResultMap" type="com.xxxxx.core.sequence.impl.MysqlSequenceBo"><br>        <result column="SEQ_NAME" property="seqName" jdbctype="VARCHAR"><br>        <result column="SEQ_VALUE" property="seqValue" jdbctype="BIGINT"><br>        <result column="MIN_VALUE" property="minValue" jdbctype="BIGINT"><br>        <result column="MAX_VALUE" property="maxValue" jdbctype="BIGINT"><br>        <result column="STEP" property="step" jdbctype="BIGINT"><br>        <result column="TM_CREATE" property="tmCreate" jdbctype="TIMESTAMP"><br>        <result column="TM_SMP" property="tmSmp" jdbctype="TIMESTAMP"><br>    </result></result></result></result></result></result></result></resultmap><br>    <delete id="delSequence" parametertype="java.lang.String"><br>        delete from t_pub_sequence<br>        where SEQ_NAME = #{seqName,jdbcType=VARCHAR}<br>    </delete><br>    <insert id="createSequence" parametertype="com.xxxxx.core.sequence.impl.MysqlSequenceBo"><br>        insert into t_pub_sequence (SEQ_NAME,SEQ_VALUE,MIN_VALUE,MAX_VALUE,STEP,TM_CREATE)<br>        values (#{seqName,jdbcType=VARCHAR}, #{seqValue,jdbcType=BIGINT},</insert></mapper></p>
<pre><code>    #{minValue,jdbcType=BIGINT}, #{maxValue,jdbcType=BIGINT}, #{step,jdbcType=BIGINT},
    now())
&lt;/insert&gt;
&lt;update id=&quot;updSequence&quot; parameterType=&quot;com.xxxxx.core.sequence.impl.MysqlSequenceBo&quot; &gt;
    update t_pub_sequence
    set SEQ_VALUE = #{newValue,jdbcType=BIGINT}
    where SEQ_NAME = #{seqName,jdbcType=VARCHAR} and SEQ_VALUE = #{oldValue,jdbcType=BIGINT}
&lt;/update&gt;

&lt;select id=&quot;getAll&quot; resultMap=&quot;BaseResultMap&quot; &gt;
    select SEQ_NAME, SEQ_VALUE, MIN_VALUE, MAX_VALUE, STEP
    from t_pub_sequence
&lt;/select&gt;

&lt;select id=&quot;getSequence&quot; resultMap=&quot;BaseResultMap&quot; &gt;
    select SEQ_NAME, SEQ_VALUE, MIN_VALUE, MAX_VALUE, STEP
    from t_pub_sequence
    where SEQ_NAME = #{seqName,jdbcType=VARCHAR}
&lt;/select&gt;
</code></pre><p><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 接口实现</div></pre></td></tr></table></figure></p>
<p>@Repository(“mysqlSequence”)<br>public class MysqlSequenceImpl implements MysqlSequence{</p>
<pre><code>@Autowired
private MysqlSequenceFactory mysqlSequenceFactory;
/**
 * &lt;p&gt;
 * 获取指定sequence的序列号
 * &lt;/p&gt;
 *
 * @param seqName sequence名
 * @return String 序列号
 * @author coderzl
 */
@Override
public String nextVal(String seqName) {
    return Objects.toString(mysqlSequenceFactory.getNextVal(seqName));
}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 工厂</div></pre></td></tr></table></figure></p>
<p>@Component<br>public class MysqlSequenceFactory {</p>
<pre><code>private final Lock lock = new ReentrantLock();

/**  */
private Map&lt;String,MysqlSequenceHolder&gt; holderMap = new ConcurrentHashMap&lt;&gt;();

@Autowired
private MysqlSequenceDAO msqlSequenceDAO;
/** 单个sequence初始化乐观锁更新失败重试次数 */
@Value(&quot;${seq.init.retry:5}&quot;)
private int initRetryNum;
/** 单个sequence更新序列区间乐观锁更新失败重试次数 */
@Value(&quot;${seq.get.retry:20}&quot;)
private int getRetryNum;

@PostConstruct
private void init(){
    //初始化所有sequence
    initAll();
}


/**
 * &lt;p&gt; 加载表中所有sequence，完成初始化 &lt;/p&gt;
 * @return void
 * @author coderzl
 */
private void initAll(){
    try {
        lock.lock();
        List&lt;MysqlSequenceBo&gt; boList = msqlSequenceDAO.getAll();
        if (boList == null) {
            throw new IllegalArgumentException(&quot;The sequenceRecord is null!&quot;);
        }
        for (MysqlSequenceBo bo : boList) {
            MysqlSequenceHolder holder = new MysqlSequenceHolder(msqlSequenceDAO, bo,initRetryNum,getRetryNum);
            holder.init();
            holderMap.put(bo.getSeqName(), holder);
        }
    }finally {
        lock.unlock();
    }
}


/**
 * &lt;p&gt;  &lt;/p&gt;
 * @param seqName
 * @return long
 * @author coderzl
 */
public long getNextVal(String seqName){
    MysqlSequenceHolder holder = holderMap.get(seqName);
    if (holder == null) {
        try {
            lock.lock();
            holder = holderMap.get(seqName);
            if (holder != null){
                return holder.getNextVal();
            }
            MysqlSequenceBo bo = msqlSequenceDAO.getSequence(seqName);
            holder = new MysqlSequenceHolder(msqlSequenceDAO, bo,initRetryNum,getRetryNum);
            holder.init();
            holderMap.put(seqName, holder);
        }finally {
           lock.unlock();
        }
    }
    return holder.getNextVal();
}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">####</div></pre></td></tr></table></figure></p>
<p>public class MysqlSequenceHolder {</p>
<pre><code>private final Lock lock                = new ReentrantLock();

/** seqName */
private String seqName;

/** sequenceDao */
private MysqlSequenceDAO sequenceDAO;

private MysqlSequenceBo sequenceBo;
/**  */
private SequenceRange sequenceRange;
/** 是否初始化 */
private volatile boolean       isInitialize      = false;
/** sequence初始化重试次数 */
private int initRetryNum;
/** sequence获取重试次数 */
private int getRetryNum;

/**
 * &lt;p&gt; 构造方法 &lt;/p&gt;
 * @Title MysqlSequenceHolder
 * @param sequenceDAO 
 * @param sequenceBo
 * @param initRetryNum 初始化时，数据库更新失败后重试次数
 * @param getRetryNum 获取nextVal时，数据库更新失败后重试次数
 * @return
 * @author coderzl
 */
public MysqlSequenceHolder(MysqlSequenceDAO sequenceDAO, MysqlSequenceBo sequenceBo,int initRetryNum,int getRetryNum) {
    this.sequenceDAO = sequenceDAO;
    this.sequenceBo = sequenceBo;
    this.initRetryNum = initRetryNum;
    this.getRetryNum = getRetryNum;
    if(sequenceBo != null)
        this.seqName = sequenceBo.getSeqName();
}

/**
 * &lt;p&gt; 初始化 &lt;/p&gt;
 * @Title init
 * @Description
 * @param
 * @return void
 * @author coderzl
 */
public void init(){
    if (isInitialize == true) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the MysqlSequenceHolder has inited&quot;);
    }
    if (sequenceDAO == null) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceDao is null&quot;);
    }
    if (seqName == null || seqName.trim().length() == 0) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceName is null&quot;);
    }
    if (sequenceBo == null) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceBo is null&quot;);
    }
    if (!sequenceBo.validate()){
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceBo validate fail. BO:&quot;+sequenceBo);
    }
    // 初始化该sequence
    try {
        initSequenceRecord(sequenceBo);
    } catch (SequenceException e) {
        throw e;
    }
    isInitialize = true;
}

/**
 * &lt;p&gt; 获取下一个序列号 &lt;/p&gt;
 * @Title getNextVal
 * @param
 * @return long
 * @author coderzl
 */
public long getNextVal(){
    if(isInitialize == false){
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the MysqlSequenceHolder not inited&quot;);
    }
    if(sequenceRange == null){
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceRange is null&quot;);
    }
    long curValue = sequenceRange.getAndIncrement();

    if(curValue == -1){
        try{
            lock.lock();
            curValue = sequenceRange.getAndIncrement();
            if(curValue != -1){
                return curValue;
            }
            sequenceRange = retryRange();
            curValue = sequenceRange.getAndIncrement();
        }finally {
            lock.unlock();
        }
    }
    return curValue;
}

/**
 * &lt;p&gt; 初始化当前这条记录 &lt;/p&gt;
 * @Title initSequenceRecord
 * @Description
 * @param sequenceBo
 * @return void
 * @date  2017/6/11 15:53
 * @author coderzl
 */
private void initSequenceRecord(MysqlSequenceBo sequenceBo){
    for(int i = 1; i &lt; initRetryNum; i++){
        //查询bo
        MysqlSequenceBo curBo = sequenceDAO.getSequence(sequenceBo.getSeqName());
        if(curBo == null){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo is null&quot;);
        }
        if (!curBo.validate()){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo validate fail&quot;);
        }
        //改变当前值
        long newValue = curBo.getSeqValue()+curBo.getStep();
        //检查当前值
        if(!checkCurrentValue(newValue,curBo)){
            newValue = resetCurrentValue(curBo);
        }
        int result = sequenceDAO.updSequence(sequenceBo.getSeqName(),curBo.getSeqValue(),newValue);
        if(result &gt; 0){
            sequenceRange = new SequenceRange(curBo.getSeqValue(),newValue - 1);
            curBo.setSeqValue(newValue);
            this.sequenceBo = curBo;
            return;
        }else{
            continue;
        }
    }
    throw new SequenceException(&quot;[&quot; + seqName + &quot;]  sequenceBo update error&quot;);
}

/**
 * &lt;p&gt; 检查新值是否合法 &lt;/p&gt;
 * @Title checkCurrentValue
 * @param curValue
 * @param curBo
 * @return boolean
 * @author coderzl
 */
private boolean checkCurrentValue(long curValue,MysqlSequenceBo curBo){
    if(curValue &gt; curBo.getMinValue() &amp;&amp; curValue &lt;= curBo.getMaxValue()){
        return true;
    }
    return false;
}

/**
 * &lt;p&gt; 重置sequence当前值 ：当前sequence达到最大值时，重新从最小值开始 &lt;/p&gt;
 * @Title resetCurrentValue
 * @param curBo
 * @return long
 * @author coderzl
 */
private long resetCurrentValue(MysqlSequenceBo curBo){
    return curBo.getMinValue();
}

/**
 * &lt;p&gt; 缓存区间使用完毕时，重新读取数据库记录，缓存新序列段 &lt;/p&gt;
 * @Title retryRange
 * @param SequenceRange
 * @author coderzl
 */
private SequenceRange retryRange(){
    for(int i = 1; i &lt; getRetryNum; i++){
        //查询bo
        MysqlSequenceBo curBo = sequenceDAO.getSequence(sequenceBo.getSeqName());
        if(curBo == null){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo is null&quot;);
        }
        if (!curBo.validate()){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo validate fail&quot;);
        }
        //改变当前值
        long newValue = curBo.getSeqValue()+curBo.getStep();
        //检查当前值
        if(!checkCurrentValue(newValue,curBo)){
            newValue = resetCurrentValue(curBo);
        }
        int result = sequenceDAO.updSequence(sequenceBo.getSeqName(),curBo.getSeqValue(),newValue);
        if(result &gt; 0){
            sequenceRange = new SequenceRange(curBo.getSeqValue(),newValue - 1);
            curBo.setSeqValue(newValue);
            this.sequenceBo = curBo;
            return sequenceRange;
        }else{
            continue;
        }
    }
    throw new SequenceException(&quot;[&quot; + seqName + &quot;]  sequenceBo update error&quot;);

}
</code></pre><p>}</p>
<p>```</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <ul class="post-copyright">
    <li class="post-copyright-author">
      <strong>本文作者：</strong>
      ZhangLong
    </li>
    <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://zhanglong.wiki/2017/06/12/framework/基于Mysql的Sequence实现/" title="基于Mysql的Sequence实现">http://zhanglong.wiki/2017/06/12/framework/基于Mysql的Sequence实现/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明： </strong>
      本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
    </li>
  </ul>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Mysql/" rel="tag"># Mysql</a>
          
            <a href="/tags/Sequence/" rel="tag"># Sequence</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/04/随笔/马克吐槽/" rel="prev" title="马克吐槽">
                马克吐槽 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="ZhangLong" />
          <p class="site-author-name" itemprop="name">ZhangLong</p>
           
              <p class="site-description motion-element" itemprop="description">胡乱的编...</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/coderzl" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#基于mysql函数实现"><span class="nav-number">1.</span> <span class="nav-text">基于mysql函数实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#表结构"><span class="nav-number">1.1.</span> <span class="nav-text">表结构</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZhangLong</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "5d0bd8cf1ccf43548e03641e0267b6a7",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  

  

  

</body>
</html>
