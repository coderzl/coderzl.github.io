<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="胡乱的编...">
<meta property="og:type" content="website">
<meta property="og:title" content="阿拉丁的混乱笔记">
<meta property="og:url" content="http://zhanglong.wiki/index.html">
<meta property="og:site_name" content="阿拉丁的混乱笔记">
<meta property="og:description" content="胡乱的编...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阿拉丁的混乱笔记">
<meta name="twitter:description" content="胡乱的编...">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhanglong.wiki/"/>





  <title> 阿拉丁的混乱笔记 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?986e78470dad7463885a41106c411043";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">阿拉丁的混乱笔记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">编的好费力!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocapitalize="off" autocomplete="off" autocorrect="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/06/12/framework/基于Mysql的Sequence实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/12/framework/基于Mysql的Sequence实现/" itemprop="url">
                  基于Mysql的Sequence实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-12T00:00:00+08:00">
                2017-06-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/framework/" itemprop="url" rel="index">
                    <span itemprop="name">framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>  之前有提到过，团队更换新框架。新的业务全部使用新的框架，甚至是新的数据库–Mysql。<br>这边之前一直是使用oracle，各种订单号、流水号、批次号啥的，都是直接使用oracle的sequence提供的数字序列号。现在数据库更换成Mysql了，显然以前的老方法不能适用了。<br>  需要新写一个：</p>
<ul>
<li>分布式场景使用</li>
<li>满足一定的并发要求<br>找了一些相关的资料，发现mysql这方面的实现，原理都是一条数据库记录，不断update它的值。然后大部分的实现方案，都用到了函数。<br>贴一下网上的代码：<h3 id="基于mysql函数实现"><a href="#基于mysql函数实现" class="headerlink" title="基于mysql函数实现"></a>基于mysql函数实现</h3><h4 id="表结构"><a href="#表结构" class="headerlink" title="表结构"></a>表结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `t_sequence` (</div><div class="line">`sequence_name`  varchar(64) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL COMMENT &apos;序列名称&apos; ,</div><div class="line">`value`  int(11) NULL DEFAULT NULL COMMENT &apos;当前值&apos; ,</div><div class="line">PRIMARY KEY (`sequence_name`)</div><div class="line">)</div><div class="line">ENGINE=InnoDB</div><div class="line">DEFAULT CHARACTER SET=utf8 COLLATE=utf8_general_ci</div><div class="line">ROW_FORMAT=COMPACT</div><div class="line">;</div><div class="line"></div><div class="line">```  </div><div class="line"></div><div class="line">#### 获取下一个值</div></pre></td></tr></table></figure>
</li>
</ul>
<p>CREATE DEFINER = <code>root</code>@<code>localhost</code> FUNCTION <code>nextval</code>(sequence_name varchar(64))<br> RETURNS int(11)<br>BEGIN<br>    declare current integer;<br>    set current = 0;</p>
<pre><code>update t_sequence t set t.value = t.value + 1 where t.sequence_name = sequence_name;
select t.value into current from t_sequence t where t.sequence_name = sequence_name;

return current;
</code></pre><p>end;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">### 基于java缓存实现</div><div class="line">  并发场景有可能会出问题吧，虽然可以在业务层加锁，但分布式场景就无法保证了，然后效率应该也不会高。</div><div class="line">自己实现一个，java版</div><div class="line">  原理：</div><div class="line">   - 读取一条记录，缓存一个数据段，如：0-100，将记录的当前值从0修改为100</div><div class="line">   - 数据库乐观锁更新，允许重试</div><div class="line">   - 读取数据从缓存中读取，用完再读取数据库</div><div class="line"></div><div class="line">  不废话，上代码：</div><div class="line">#### 表结构</div></pre></td></tr></table></figure>
<p>CREATE TABLE <code>t_pub_sequence</code> (<br>  <code>SEQ_NAME</code> varchar(128) CHARACTER SET utf8 NOT NULL COMMENT ‘序列名称’,<br>  <code>SEQ_VALUE</code> bigint(20) NOT NULL COMMENT ‘目前序列值’,<br>  <code>MIN_VALUE</code> bigint(20) NOT NULL COMMENT ‘最小值’,<br>  <code>MAX_VALUE</code> bigint(20) NOT NULL COMMENT ‘最大值’,<br>  <code>STEP</code> bigint(20) NOT NULL COMMENT ‘每次取值的数量’,<br>  <code>TM_CREATE</code> datetime NOT NULL COMMENT ‘创建时间’,<br>  <code>TM_SMP</code> datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT ‘修改时间’,<br>  PRIMARY KEY (<code>SEQ_NAME</code>)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT=’流水号生成表’;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### sequence接口</div></pre></td></tr></table></figure>
<p>/**</p>
<ul>
<li><p></p></li>
<li>@author coderzl</li>
<li>@Title MysqlSequence</li>
<li>@Description 基于mysql数据库实现的序列</li>
<li>@date 2017/6/6 23:03<br><em>/<br>public interface MysqlSequence {<br> /*</em><ul>
<li><p></p></li>
<li>获取指定sequence的序列号</li>
<li><p></p></li>
<li>@param  seqName sequence名</li>
<li>@return String 序列号<br>*/<br>public String nextVal(String seqName);<br>}</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 序列区间</div><div class="line">（用于本地缓存一段序列）</div></pre></td></tr></table></figure>
<p>/**</p>
<ul>
<li><p></p><br>*</li>
<li>@author coderzl</li>
<li>@Title SequenceRange</li>
<li>@Description 序列区间，用于缓存序列</li>
<li><p>@date 2017/6/6 22:58<br><em>/<br>@Data<br>public class SequenceRange {<br> private final long       min;<br> private final long       max;<br> /**  </em>/<br> private final AtomicLong value;<br> /<em>* 是否超限 </em>/<br> private volatile boolean over = false;</p>
<p> /**</p>
<ul>
<li>构造.<br>*</li>
<li>@param min </li>
<li><p>@param max<br>*/<br>public SequenceRange(long min, long max) {<br> this.min = min;<br> this.max = max;<br> this.value = new AtomicLong(min);<br>}</p>
<p>/**</p>
</li>
<li><p>Gets and increment</p><br>*</li>
<li><p>@return<br>*/<br>public long getAndIncrement() {<br> long currentValue = value.getAndIncrement();<br> if (currentValue &gt; max) {</p>
<pre><code>over = true;
return -1;
</code></pre><p> }</p>
<p> return currentValue;<br>}</p>
</li>
</ul>
</li>
</ul>
<p>}   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### BO </div><div class="line">  对应数据库记录</div></pre></td></tr></table></figure>
<p>@Data<br>public class MysqlSequenceBo {<br>    /**</p>
<pre><code> * seq名
 */
private String seqName;
/**
 * 当前值
 */
private Long seqValue;
/**
 * 最小值
 */
private Long minValue;
/**
 * 最大值
 */
private Long maxValue;
/**
 * 每次取值的数量
 */
private Long step;
/**  */
private Date tmCreate;
/**  */
private Date tmSmp;

public boolean validate(){
  //一些简单的校验。如当前值必须在最大最小值之间。step值不能大于max与min的差
  if (StringUtil.isBlank(seqName) || minValue &lt; 0 || maxValue &lt;= 0 || step &lt;= 0 || minValue &gt;= maxValue || maxValue - minValue &lt;= step ||seqValue &lt; minValue || seqValue &gt; maxValue ) {
        return false;
    }
    return true;  
}
</code></pre><p>}    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### DAO </div><div class="line">增删改查，其实就用到了改和查</div></pre></td></tr></table></figure>
<p>public interface MysqlSequenceDAO {<br>    /**</p>
<pre><code>* 
*/
public int createSequence(MysqlSequenceBo bo);

public int updSequence(@Param(&quot;seqName&quot;) String seqName, @Param(&quot;oldValue&quot;) long oldValue ,@Param(&quot;newValue&quot;) long newValue);

public int delSequence(@Param(&quot;seqName&quot;) String seqName);

public MysqlSequenceBo getSequence(@Param(&quot;seqName&quot;) String seqName);

public List&lt;MysqlSequenceBo&gt; getAll();
</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### Mapper</div></pre></td></tr></table></figure>
<p>&lt;?xml version=”1.0” encoding=”UTF-8” ?&gt;<br>&lt;!DOCTYPE mapper PUBLIC “-//mybatis.org//DTD Mapper 3.0//EN” “<a href="http://mybatis.org/dtd/mybatis-3-mapper.dtd" target="_blank" rel="external">http://mybatis.org/dtd/mybatis-3-mapper.dtd</a>“ &gt;</p>
<mapper namespace="com.xxxxx.core.sequence.impl.dao.MysqlSequenceDAO"><br>    <resultmap id="BaseResultMap" type="com.xxxxx.core.sequence.impl.MysqlSequenceBo"><br>        <result column="SEQ_NAME" property="seqName" jdbctype="VARCHAR"><br>        <result column="SEQ_VALUE" property="seqValue" jdbctype="BIGINT"><br>        <result column="MIN_VALUE" property="minValue" jdbctype="BIGINT"><br>        <result column="MAX_VALUE" property="maxValue" jdbctype="BIGINT"><br>        <result column="STEP" property="step" jdbctype="BIGINT"><br>        <result column="TM_CREATE" property="tmCreate" jdbctype="TIMESTAMP"><br>        <result column="TM_SMP" property="tmSmp" jdbctype="TIMESTAMP"><br>    </result></result></result></result></result></result></result></resultmap><br>    <delete id="delSequence" parametertype="java.lang.String"><br>        delete from t_pub_sequence<br>        where SEQ_NAME = #{seqName,jdbcType=VARCHAR}<br>    </delete><br>    <insert id="createSequence" parametertype="com.xxxxx.core.sequence.impl.MysqlSequenceBo"><br>        insert into t_pub_sequence (SEQ_NAME,SEQ_VALUE,MIN_VALUE,MAX_VALUE,STEP,TM_CREATE)<br>        values (#{seqName,jdbcType=VARCHAR}, #{seqValue,jdbcType=BIGINT},<br>        #{minValue,jdbcType=BIGINT}, #{maxValue,jdbcType=BIGINT}, #{step,jdbcType=BIGINT},<br>        now())<br>    </insert><br>    <update id="updSequence" parametertype="com.xxxxx.core.sequence.impl.MysqlSequenceBo"><br>        update t_pub_sequence<br>        set SEQ_VALUE = #{newValue,jdbcType=BIGINT}<br>        where SEQ_NAME = #{seqName,jdbcType=VARCHAR} and SEQ_VALUE = #{oldValue,jdbcType=BIGINT}<br>    </update><br><br>    <select id="getAll" resultmap="BaseResultMap"><br>        select SEQ_NAME, SEQ_VALUE, MIN_VALUE, MAX_VALUE, STEP<br>        from t_pub_sequence<br>    </select><br><br>    <select id="getSequence" resultmap="BaseResultMap"><br>        select SEQ_NAME, SEQ_VALUE, MIN_VALUE, MAX_VALUE, STEP<br>        from t_pub_sequence<br>        where SEQ_NAME = #{seqName,jdbcType=VARCHAR}<br>    </select><br></mapper>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 接口实现</div></pre></td></tr></table></figure>
<p>@Repository(“mysqlSequence”)<br>public class MysqlSequenceImpl implements MysqlSequence{</p>
<pre><code>@Autowired
private MysqlSequenceFactory mysqlSequenceFactory;
/**
 * &lt;p&gt;
 * 获取指定sequence的序列号
 * &lt;/p&gt;
 *
 * @param seqName sequence名
 * @return String 序列号
 * @author coderzl
 */
@Override
public String nextVal(String seqName) {
    return Objects.toString(mysqlSequenceFactory.getNextVal(seqName));
}
</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### 工厂</div></pre></td></tr></table></figure>
<p>@Component<br>public class MysqlSequenceFactory {</p>
<pre><code>private final Lock lock = new ReentrantLock();

/**  */
private Map&lt;String,MysqlSequenceHolder&gt; holderMap = new ConcurrentHashMap&lt;&gt;();

@Autowired
private MysqlSequenceDAO msqlSequenceDAO;
/** 单个sequence初始化乐观锁更新失败重试次数 */
@Value(&quot;${seq.init.retry:5}&quot;)
private int initRetryNum;
/** 单个sequence更新序列区间乐观锁更新失败重试次数 */
@Value(&quot;${seq.get.retry:20}&quot;)
private int getRetryNum;

@PostConstruct
private void init(){
    //初始化所有sequence
    initAll();
}


/**
 * &lt;p&gt; 加载表中所有sequence，完成初始化 &lt;/p&gt;
 * @return void
 * @author coderzl
 */
private void initAll(){
    try {
        lock.lock();
        List&lt;MysqlSequenceBo&gt; boList = msqlSequenceDAO.getAll();
        if (boList == null) {
            throw new IllegalArgumentException(&quot;The sequenceRecord is null!&quot;);
        }
        for (MysqlSequenceBo bo : boList) {
            MysqlSequenceHolder holder = new MysqlSequenceHolder(msqlSequenceDAO, bo,initRetryNum,getRetryNum);
            holder.init();
            holderMap.put(bo.getSeqName(), holder);
        }
    }finally {
        lock.unlock();
    }
}


/**
 * &lt;p&gt;  &lt;/p&gt;
 * @param seqName
 * @return long
 * @author coderzl
 */
public long getNextVal(String seqName){
    MysqlSequenceHolder holder = holderMap.get(seqName);
    if (holder == null) {
        try {
            lock.lock();
            holder = holderMap.get(seqName);
            if (holder != null){
                return holder.getNextVal();
            }
            MysqlSequenceBo bo = msqlSequenceDAO.getSequence(seqName);
            holder = new MysqlSequenceHolder(msqlSequenceDAO, bo,initRetryNum,getRetryNum);
            holder.init();
            holderMap.put(seqName, holder);
        }finally {
           lock.unlock();
        }
    }
    return holder.getNextVal();
}
</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">####</div></pre></td></tr></table></figure>
<p>public class MysqlSequenceHolder {</p>
<pre><code>private final Lock lock                = new ReentrantLock();

/** seqName */
private String seqName;

/** sequenceDao */
private MysqlSequenceDAO sequenceDAO;

private MysqlSequenceBo sequenceBo;
/**  */
private SequenceRange sequenceRange;
/** 是否初始化 */
private volatile boolean       isInitialize      = false;
/** sequence初始化重试次数 */
private int initRetryNum;
/** sequence获取重试次数 */
private int getRetryNum;

/**
 * &lt;p&gt; 构造方法 &lt;/p&gt;
 * @Title MysqlSequenceHolder
 * @param sequenceDAO 
 * @param sequenceBo
 * @param initRetryNum 初始化时，数据库更新失败后重试次数
 * @param getRetryNum 获取nextVal时，数据库更新失败后重试次数
 * @return
 * @author coderzl
 */
public MysqlSequenceHolder(MysqlSequenceDAO sequenceDAO, MysqlSequenceBo sequenceBo,int initRetryNum,int getRetryNum) {
    this.sequenceDAO = sequenceDAO;
    this.sequenceBo = sequenceBo;
    this.initRetryNum = initRetryNum;
    this.getRetryNum = getRetryNum;
    if(sequenceBo != null)
        this.seqName = sequenceBo.getSeqName();
}

/**
 * &lt;p&gt; 初始化 &lt;/p&gt;
 * @Title init
 * @Description
 * @param
 * @return void
 * @author coderzl
 */
public void init(){
    if (isInitialize == true) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the MysqlSequenceHolder has inited&quot;);
    }
    if (sequenceDAO == null) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceDao is null&quot;);
    }
    if (seqName == null || seqName.trim().length() == 0) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceName is null&quot;);
    }
    if (sequenceBo == null) {
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceBo is null&quot;);
    }
    if (!sequenceBo.validate()){
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceBo validate fail. BO:&quot;+sequenceBo);
    }
    // 初始化该sequence
    try {
        initSequenceRecord(sequenceBo);
    } catch (SequenceException e) {
        throw e;
    }
    isInitialize = true;
}

/**
 * &lt;p&gt; 获取下一个序列号 &lt;/p&gt;
 * @Title getNextVal
 * @param
 * @return long
 * @author coderzl
 */
public long getNextVal(){
    if(isInitialize == false){
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the MysqlSequenceHolder not inited&quot;);
    }
    if(sequenceRange == null){
        throw new SequenceException(&quot;[&quot; + seqName + &quot;] the sequenceRange is null&quot;);
    }
    long curValue = sequenceRange.getAndIncrement();

    if(curValue == -1){
        try{
            lock.lock();
            curValue = sequenceRange.getAndIncrement();
            if(curValue != -1){
                return curValue;
            }
            sequenceRange = retryRange();
            curValue = sequenceRange.getAndIncrement();
        }finally {
            lock.unlock();
        }
    }
    return curValue;
}

/**
 * &lt;p&gt; 初始化当前这条记录 &lt;/p&gt;
 * @Title initSequenceRecord
 * @Description
 * @param sequenceBo
 * @return void
 * @date  2017/6/11 15:53
 * @author coderzl
 */
private void initSequenceRecord(MysqlSequenceBo sequenceBo){
    for(int i = 1; i &lt; initRetryNum; i++){
        //查询bo
        MysqlSequenceBo curBo = sequenceDAO.getSequence(sequenceBo.getSeqName());
        if(curBo == null){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo is null&quot;);
        }
        if (!curBo.validate()){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo validate fail&quot;);
        }
        //改变当前值
        long newValue = curBo.getSeqValue()+curBo.getStep();
        //检查当前值
        if(!checkCurrentValue(newValue,curBo)){
            newValue = resetCurrentValue(curBo);
        }
        int result = sequenceDAO.updSequence(sequenceBo.getSeqName(),curBo.getSeqValue(),newValue);
        if(result &gt; 0){
            sequenceRange = new SequenceRange(curBo.getSeqValue(),newValue - 1);
            curBo.setSeqValue(newValue);
            this.sequenceBo = curBo;
            return;
        }else{
            continue;
        }
    }
    throw new SequenceException(&quot;[&quot; + seqName + &quot;]  sequenceBo update error&quot;);
}

/**
 * &lt;p&gt; 检查新值是否合法 &lt;/p&gt;
 * @Title checkCurrentValue
 * @param curValue
 * @param curBo
 * @return boolean
 * @author coderzl
 */
private boolean checkCurrentValue(long curValue,MysqlSequenceBo curBo){
    if(curValue &gt; curBo.getMinValue() &amp;&amp; curValue &lt;= curBo.getMaxValue()){
        return true;
    }
    return false;
}

/**
 * &lt;p&gt; 重置sequence当前值 ：当前sequence达到最大值时，重新从最小值开始 &lt;/p&gt;
 * @Title resetCurrentValue
 * @param curBo
 * @return long
 * @author coderzl
 */
private long resetCurrentValue(MysqlSequenceBo curBo){
    return curBo.getMinValue();
}

/**
 * &lt;p&gt; 缓存区间使用完毕时，重新读取数据库记录，缓存新序列段 &lt;/p&gt;
 * @Title retryRange
 * @param SequenceRange
 * @author coderzl
 */
private SequenceRange retryRange(){
    for(int i = 1; i &lt; getRetryNum; i++){
        //查询bo
        MysqlSequenceBo curBo = sequenceDAO.getSequence(sequenceBo.getSeqName());
        if(curBo == null){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo is null&quot;);
        }
        if (!curBo.validate()){
            throw new SequenceException(&quot;[&quot; + seqName + &quot;] the current sequenceBo validate fail&quot;);
        }
        //改变当前值
        long newValue = curBo.getSeqValue()+curBo.getStep();
        //检查当前值
        if(!checkCurrentValue(newValue,curBo)){
            newValue = resetCurrentValue(curBo);
        }
        int result = sequenceDAO.updSequence(sequenceBo.getSeqName(),curBo.getSeqValue(),newValue);
        if(result &gt; 0){
            sequenceRange = new SequenceRange(curBo.getSeqValue(),newValue - 1);
            curBo.setSeqValue(newValue);
            this.sequenceBo = curBo;
            return sequenceRange;
        }else{
            continue;
        }
    }
    throw new SequenceException(&quot;[&quot; + seqName + &quot;]  sequenceBo update error&quot;);

}
</code></pre><p>}</p>
<p>```</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/06/04/framework/Spring多数据源配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/04/framework/Spring多数据源配置/" itemprop="url">
                  Spring多数据源配置（未完成）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-04T00:00:00+08:00">
                2017-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/framework/" itemprop="url" rel="index">
                    <span itemprop="name">framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>  项目团队最近需要更换框架，临时搭建一套组合框架。小项目，两个数据库：业务库，配置库。根据实际业务，动态切换。<br>之前对这块配置处理没有什么了解，看了一些资料以及以前框架的实现，了解了下思路，做个笔记整理：<br>1、自定义一个DataSource，Map<string,javax.sql.datasource>存放所有数据源<br>2、重写getConnection(),根据key值从map中获取DataSource，并返回连接<br>3、定义一个上下文DataRouteContext 利用ThreadLocal<string> 存储当前线程当前需要获取的数据源key值<br>4、自定义一个注解@DataSource(“key”)<br>5、自定义一个Aspect，拦截所有实现@DataSource注解的方法，将key值set到DataSourceContext</string></string,javax.sql.datasource></p>
<p>问题：如何把数据源key标记还原</p>
<pre><code>public abstract class AbstractRoutingDataSource extends AbstractDataSource implements InitializingBean
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/06/04/随笔/马克吐槽/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/04/随笔/马克吐槽/" itemprop="url">
                  马克吐槽
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-04T00:00:00+08:00">
                2017-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>前阵子开始，coding的免费用户开始有广告了，而且基本上照顾到站点的每个访问者，必然会见到一次/天。</p>
<p>博客一开始是放在了GitHub pages上了，但后来考虑到无法被百度收录，就添加了coding作为国内仓库。双仓库同步提交，云解析把默认请求解析到coding，海外请求解析到了GitHub。博客是靠三分钟的激情搭建起来的，然后开始偶尔把为知笔记上的笔记，转到博客上。晒网已久。。。上次看到广告，就琢磨着干掉coding的解析，结果随后一直没有写博客，也就不了了之……今天再次被广告恶心到，直接上云解析删掉了两个coding解析。</p>
<p>自家网络访问GitHub的速度比coding响应速度慢50-60ms，也算是可以接受了。。。毕竟博客也只是为了逼迫自己整理那混乱不堪的笔记。</p>
<p>继续撸代码，并努力再整理几篇笔记来装点一下这博客……</p>
<p>补充更新：【Chrome DNS解析错误 问题解决方案】<br>修改了云解析后，我的safari,firfox都能正常访问博客，虽然速度慢了点。但chrome一直访问不成功，直接跳转到www.zhanglong.wiki/pc.html，报【DNS解析错误】。后来发现，是chrome缓存一些解析，清空缓存就好了。<br>或者：<br>地址栏敲入：chrome://net-internals/#dns<br>点击 clean host cache</p>
<p>chrome版本：58.0.3029.110 (64-bit)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/05/10/分布式锁/Redis分布式锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/10/分布式锁/Redis分布式锁/" itemprop="url">
                  Redis分布式锁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-10T00:00:00+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式锁/" itemprop="url" rel="index">
                    <span itemprop="name">分布式锁</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <pre><code>&gt;分布式锁是控制分布式系统之间同步访问共享资源的一种方式
</code></pre><h3 id="锁接口定义"><a href="#锁接口定义" class="headerlink" title="锁接口定义"></a>锁接口定义</h3><p>  定义一个锁通用接口，对外提供锁服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LockService</span> </span>&#123;</div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 尝试获取锁</div><div class="line">     * <span class="doctag">@param</span> 锁名</div><div class="line">     */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String name)</span></span>;</div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 在指定时间内尝试获取锁</div><div class="line">     * <span class="doctag">@param</span> 锁名</div><div class="line">     * <span class="doctag">@param</span> 尝试时间</div><div class="line">     */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(String name, <span class="keyword">long</span> timeout, TimeUnit unit)</span></span>;</div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 获取锁，阻塞方法，直到获取锁成功为止</div><div class="line">     * <span class="doctag">@param</span> 锁名</div><div class="line">     */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">    <span class="comment">/** </span></div><div class="line">     * 释放锁</div><div class="line">     * <span class="doctag">@param</span> 锁名</div><div class="line">     */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">(String name)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/05/10/分布式锁/Redis分布式锁/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/04/16/hexo主题配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/hexo主题配置/" itemprop="url">
                  hexo主题配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T00:00:00+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p>选择hexo很重要的一个原因就是它丰富的主题，而配置主题的流程也很简单：<br>1、clone主题到本地<br>2、修改_config.yml配置<br>3、重新生成静态页面、发布</p>
<h4 id="下载主题"><a href="#下载主题" class="headerlink" title="下载主题"></a>下载主题</h4><p>hexo<a href="https://hexo.io">官网</a>有很多丰富的主题，选择一个，进入到它的GitHub页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> yourBlogdir/themes</div><div class="line">$ git <span class="built_in">clone</span> xxx.git</div></pre></td></tr></table></figure></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/04/16/hexo主题配置/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/04/16/hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/16/hexo/" itemprop="url">
                  Hexo + Github Pages 搭建静态博客
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-16T00:00:00+08:00">
                2017-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p>利用hexo和github pages搭建静态博客，主要操作步骤有：<br> 1、搭建node.js环境<br> 2、安装hexo<br> 3、用hexo初始化生成一个静态博客文件<br> 4、生成静态html页面<br> 5、本地起服务调试<br> 6、配置github仓库地址<br> 7、发布</p>
<h4 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h4><p>URL: <a href="https://nodejs.org/en/">下载</a></p>
<h4 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo npm install -g hexo</div></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/04/16/hexo/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/03/12/数据库/mysql加锁分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/12/数据库/mysql加锁分析/" itemprop="url">
                  mysql加锁分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-12T00:00:00+08:00">
                2017-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p>原文地址：<a href="http://hedengcheng.com/?p=771">http://hedengcheng.com/?p=771</a></p>
<p>待有时间把笔记丢上来。<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/03/12/数据库/mysql加锁分析/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/01/12/jdk/红黑树详解及代码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/12/jdk/红黑树详解及代码/" itemprop="url">
                  红黑树详解及代码(待更新)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-12T00:00:00+08:00">
                2017-01-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JDK源码笔记/" itemprop="url" rel="index">
                    <span itemprop="name">JDK源码笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <h3 id="R-B-Tree简介"><a href="#R-B-Tree简介" class="headerlink" title="R-B Tree简介"></a>R-B Tree简介</h3><p>R-B Tree，全称是Red-Black Tree，又称为“红黑树”，它一种特殊的二叉查找树。红黑树的每个节点上都有存储位表示节点的颜色，可以是红(Red)或黑(Black)。</p>
<h4 id="红黑树的特性"><a href="#红黑树的特性" class="headerlink" title="红黑树的特性:"></a>红黑树的特性:</h4><font color="red"><br>（1）每个节点或者是黑色，或者是红色。<br><br>（2）根节点是黑色。<br><br>（3）每个叶子节点（NIL）是黑色。 [注意：这里叶子节点，是指为空(NIL或NULL)的叶子节点！]<br><br>（4）如果一个节点是红色的，则它的子节点必须是黑色的。<br><br>（5）从一个节点到该节点的子孙节点的所有路径上包含相同数目的黑节点。<br></font>

<p>注意：<br>(01) 特性(3)中的叶子节点，是只为空(NIL或null)的节点。<br><br>(02) 特性(5)，确保没有一条路径会比其他路径长出俩倍。因而，红黑树是相对是接近平衡的二叉树。<br></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/01/12/jdk/红黑树详解及代码/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/01/10/jdk/LinkedList源码笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/10/jdk/LinkedList源码笔记/" itemprop="url">
                  LinkedList源码笔记(1.8)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-10T00:00:00+08:00">
                2017-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JDK源码笔记/" itemprop="url" rel="index">
                    <span itemprop="name">JDK源码笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p>LinkedList 双向链表。<br>插入删除，最多都只需要修改三个Node，速度较快<br>根据index查询，最多需要遍历半个链表（node(int index) 方法会判断从头遍历还是从尾遍历）</p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p><img src="/2017/01/10/jdk/LinkedList源码笔记/LinkedList-uml.png" alt="LinkedList-um-w358"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/01/10/jdk/LinkedList源码笔记/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://zhanglong.wiki/2017/01/10/jdk/ArrayList源码笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZhangLong">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="阿拉丁的混乱笔记">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/10/jdk/ArrayList源码笔记/" itemprop="url">
                  ArrayList源码笔记(1.8)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-10T00:00:00+08:00">
                2017-01-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JDK源码笔记/" itemprop="url" rel="index">
                    <span itemprop="name">JDK源码笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          <p>ArrayList 是一个依靠 Arrays.copyOf 方法进行动态扩展的数组。<br>增删改查本质上都是对数组进行操作，只是存在容量动态扩展的的逻辑</p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>ArrayList 是一个数组队列，相当于 <strong>动态数组</strong>。与Java中的数组相比，它的容量能动态增长。它继承于AbstractList，实现了List, RandomAccess, Cloneable, java.io.Serializable这些接口。</p>
<p>ArrayList 继承了AbstractList，实现了List。它是一个数组队列，提供了相关的添加、删除、修改、遍历等功能。</p>
<p>ArrayList 实现了RandmoAccess接口，即提供了随机访问功能。RandmoAccess是java中用来被List实现，为List提供快速访问功能的。在ArrayList中，我们即可以通过元素的序号快速获取元素对象；这就是快速随机访问。</p>
<p>ArrayList 实现了Cloneable接口，即覆盖了函数clone()，能被克隆。</p>
<p>ArrayList 实现java.io.Serializable接口，这意味着ArrayList支持序列化，能通过序列化去传输。</p>
<p>线程不安全。</p>
<p><img src="/2017/01/10/jdk/ArrayList源码笔记/ArrayList-uml.png" alt="ArrayList-um-w498"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/01/10/jdk/ArrayList源码笔记/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="ZhangLong" />
          <p class="site-author-name" itemprop="name">ZhangLong</p>
           
              <p class="site-description motion-element" itemprop="description">胡乱的编...</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/coderzl" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZhangLong</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "5d0bd8cf1ccf43548e03641e0267b6a7",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>





  

  

  

  

  

</body>
</html>
